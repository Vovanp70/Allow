# План развития ALLOW




---

## 3. Stubby: выбор варианта резолвера через монитор

**Ресурсы:** `resources/stubby` (конфиги, init.d), монитор `resources/monitor`.

**Цель:** добавить в stubby несколько вариантов upstream-резолверов (DoT) и дать пользователю выбирать активный вариант через веб-монитор.

**Задачи:**
- Описать в конфигах stubby несколько готовых вариантов резолва (например: AdGuard, Cloudflare, Quad9, системный/кастомный).
- В мониторе: новая опция/страница или блок «Резолвер DoT» с выбором варианта (выпадающий список или кнопки).
- При выборе: применение соответствующего фрагмента конфига stubby (и при необходимости stubby-family), перезапуск сервиса.
- Сохранять выбранный вариант в состоянии (state/конфиг), чтобы после перезагрузки он восстанавливался.

---

## 4. Update с сохранением настроек

**Цель:** продумать механизм обновления комплекта ALLOW (скрипты, ресурсы) с сохранением пользовательских настроек.

**Идеи:**
- Разделение: «системные» файлы (скрипты install.d, конфиги-шаблоны) и «пользовательские» (state.db, переопределения конфигов, выбранные резолверы, порты и т.д.).
- Алгоритм update: скачивание/распаковка новой версии во временную директорию; копирование только системных файлов в постоянное место; не перезаписывать файлы с пользовательскими настройками (или делать merge/backup).
- Чек-лист: что именно считается настройками (state.db, конфиги в /opt/etc/allow/*, выбор резолвера, листы ipsets и т.д.).
- Документировать сценарий отката (как откатиться на предыдущую версию с сохранением настроек).

---

## 5. Автообновление листов ipsets

**Ресурсы:** `resources/dnsmasq-full/ipsets` (bypass.txt, nonbypass.txt, zapret.txt и др.).

**Цель:** продумать автообновление списков (домены/IP) для dnsmasq-full без потери локальных правок.

**Идеи:**
- Источники списков: URL с «официальными» версиями (например, репозитории блок-листов), расписание (cron) или триггер по событию.
- Локальные правки: формат исключений/дополнений (например, отдельные файлы `*.local` или секции в существующих файлах), которые не перезаписываются при обновлении.
- Скрипт обновления: скачать → проверить (размер, базовая валидность) → применить с учётом локальных правок → перезагрузить dnsmasq.
- Опционально: интеграция в монитор (кнопка «Обновить листы», логи последнего обновления).

---

## 6. Глобальная работа по монитору

**Ресурсы:** `resources/monitor` (API, статика, шаблоны).

**Цель:** комплексное улучшение веб-монитора; детализация задач — позже.

**Направления (для последующей детализации):**
- Удобство: навигация, единый стиль страниц, отображение статусов компонентов и портов.
- Функциональность: выбор резолвера stubby (п.3), обновление ipsets (п.5), просмотр логов, применение настроек без перезагрузки где возможно.
- Надёжность: обработка ошибок API, таймауты, поведение при недоступности сервисов.
- Безопасность: доступ по паролю/сессии, ограничение доступа по IP при необходимости.

---

*Документ обновлён: 2025-01-29.*
