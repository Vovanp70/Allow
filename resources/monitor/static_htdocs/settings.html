<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки - Allow</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="/static/style.css">
    
</head>
<body>
    <div class="main-container">
        <!-- Боковое меню слева -->
        <div class="sidebar-menu">
    <div class="mobile-header">
        <a href="/dashboard.html" class="mobile-header-logo" aria-label="Allow — на главную">
            <span class="logo-all">All</span><span class="logo-allow">ow</span>
        </a>
        <button type="button" class="mobile-menu-toggle" aria-label="Открыть меню" aria-expanded="false"></button>
    </div>
    <div class="sidebar-drawer">
        <div class="sidebar-menu-top">
            <div class="logo-container">
                <h1 class="logo">
                    <span class="logo-all">All</span><span class="logo-allow">ow</span>
                </h1>
            </div>
            <a href="/dashboard.html" class="menu-item ">
                <span>Системный монитор</span>
            </a>
            <a href="/settings.html" class="menu-item active" aria-current="page">
                <span>Настройки</span>
            </a>
            <a href="/routing.html" class="menu-item ">
                <span>Маршрутизация</span>
            </a>
            <details class="menu-group" >
                <summary class="menu-item menu-group-summary">
                    <span>Расширенные настройки</span>
                </summary>
                <div class="menu-sublist">
                    <a href="/dnsmasq.html" class="menu-item menu-subitem ">
                        <span>Dnsmasq-full</span>
                    </a>
                    <a href="/dnsmasq-family.html" class="menu-item menu-subitem ">
                        <span>Dnsmasq-full family</span>
                    </a>
                    <a href="/stubby.html" class="menu-item menu-subitem ">
                        <span>Stubby</span>
                    </a>
                    <a href="/stubby-family.html" class="menu-item menu-subitem ">
                        <span>Stubby-family</span>
                    </a>
                    <a href="/sing-box.html" class="menu-item menu-subitem ">
                        <span>Sing-box</span>
                    </a>
                </div>
            </details>
        </div>
        <div class="sidebar-menu-bottom">
            <a href="/change-password.html" class="menu-item ">
                <span>Смена пароля</span>
            </a>
            <a href="/logout.html" class="menu-item menu-item-logout">
                <span>Выход</span>
            </a>
            <div class="sidebar-version">version 0.01</div>
        </div>
    </div>
</div>

        <!-- Область контента -->
        <div class="content-area">
            
<div class="settings-page">
    <header class="settings-page-header" role="banner">
        <h1>Настройки</h1>
        <div class="settings-save-bar" id="settings-save-bar" aria-live="polite">
            <span class="settings-unsaved-hint" id="settings-unsaved-hint"></span>
            <button type="button" class="btn btn-primary" id="settings-save-btn" disabled aria-describedby="settings-unsaved-hint">Сохранить</button>
        </div>
    </header>

    <section class="settings-section" aria-labelledby="settings-dot-title" aria-describedby="settings-dot-desc">
        <h2 id="settings-dot-title" class="settings-section-title">Режим работы Stubby (DoT)</h2>
        <p id="settings-dot-desc" class="settings-section-desc">Выберите режим DNS через DoT. Изменения применятся после нажатия «Сохранить».</p>
        <div class="dns-mode-cards" role="group" aria-label="Режим DNS">
            <div class="dns-mode-card" id="mode-adblock" data-mode="adblock" role="button" tabindex="0" aria-pressed="false" aria-label="DoT с блокировкой рекламы и защитой от опасных сайтов">
                <div class="dns-mode-card-header">
                    <h3>DoT + Блокировка рекламы + Защита от опасных сайтов</h3>
                </div>
                <div class="dns-mode-card-body">
                    <p>AdGuard, Control D и аналогичные серверы с фильтрацией рекламы и вредоносных сайтов.</p>
                </div>
            </div>
            <div class="dns-mode-card" id="mode-stable" data-mode="stable" role="button" tabindex="0" aria-pressed="false" aria-label="DoT с защитой от опасных сайтов, без блокировки рекламы">
                <div class="dns-mode-card-header">
                    <h3>DoT + Защита от опасных сайтов</h3>
                </div>
                <div class="dns-mode-card-body">
                    <p>Cloudflare, Yandex и другие стабильные DoT-серверы с защитой от опасных сайтов, без блокировки рекламы.</p>
                </div>
            </div>
            <div class="dns-mode-card dns-mode-card-manual" id="mode-manual" data-mode="manual" role="button" tabindex="0" aria-pressed="false" aria-label="Ручная настройка конфига">
                <div class="dns-mode-card-header">
                    <h3>Ручная настройка (конфиг изменён)</h3>
                </div>
                <div class="dns-mode-card-body">
                    <p>Конфигурация Stubby была изменена вручную. Переключение на adblock или stable применит соответствующий набор серверов.</p>
                </div>
            </div>
        </div>
        <p class="dns-mode-status settings-section-status" id="dns-mode-status"></p>
    </section>

    <section class="settings-section">
        <div class="card settings-card children-filter-card">
            <div class="card-content" role="group" aria-labelledby="children-filter-title">
                <div class="children-filter-text">
                    <h2 id="children-filter-title" class="settings-section-title">Фильтрация контента для детей</h2>
                    <p class="settings-section-desc">Stubby-family и Dnsmasq-full family работают вместе для фильтрации контента на детских устройствах. Включение запускает оба компонента и добавляет их в автозапуск.</p>
                </div>
                <div class="children-filter-toggle-container">
                    <label class="switch" for="children-filter-toggle">
                        <input type="checkbox" id="children-filter-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </section>

    <section class="settings-section">
        <div class="card settings-card updates-card">
            <div class="card-content">
                <div class="updates-main">
                    <h2 class="settings-section-title">Обновления</h2>
                    <p class="settings-section-desc">
                        Синхронизация списков allow (домены, подсети) из upstream и extra-репозитория.
                        Автообновление по cron в 04:00.
                    </p>
                </div>
                <div class="updates-one-row">
                    <span class="settings-card-label">Автообновление</span>
                    <label class="switch">
                        <input type="checkbox" id="sync-allow-autoupdate-toggle">
                        <span class="slider"></span>
                    </label>
                    <span class="settings-card-label updates-one-row-sep">Последнее обновление</span>
                    <span id="sync-allow-last-update">—</span>
                </div>
                <span id="sync-allow-autoupdate-status" class="visually-hidden" aria-hidden="true">—</span>
                <div class="updates-actions-footer">
                    <button type="button" class="btn btn-secondary" id="sync-allow-logs-btn">Посмотреть логи</button>
                    <button type="button" class="btn btn-secondary" id="sync-allow-update-btn">Обновить списки</button>
                </div>
            </div>
        </div>
    </section>

    <section class="settings-section">
        <div class="card settings-card singbox-card">
            <div class="card-content">
                <div class="singbox-main">
                    <h2 class="settings-section-title">Sing-box: прокси (outbound'ы)</h2>
                </div>
                <div class="singbox-body">
                    <div id="singbox-settings-proxy-selector" class="singbox-settings-proxy-selector" style="display: none; margin-bottom: 14px;">
                        <div class="info-item" style="margin-bottom: 6px;">
                            <span class="label">Текущий прокси:</span>
                        </div>
                        <div id="singbox-settings-proxy-selector-list" class="singbox-proxy-options" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        <div id="singbox-settings-proxy-selector-error" class="singbox-proxy-error" style="display: none; color: #c00; font-size: 13px; margin-top: 6px;"></div>
                        <div style="margin-top: 8px;">
                            <button type="button" class="btn btn-secondary" id="singbox-settings-proxy-delay-btn" style="padding: 4px 10px; font-size: 12px;">Проверить задержку</button>
                            <span id="singbox-settings-proxy-delay-result" class="form-hint" style="margin-left: 8px;"></span>
                        </div>
                    </div>
                    <div id="singbox-urltest-options" class="singbox-urltest-options" style="display: none; margin-bottom: 14px; padding: 10px; background: #f5f5f7; border-radius: 8px;">
                        <h3 class="settings-subsection-title" style="margin: 0 0 10px 0; font-size: 14px;">Параметры URLTest</h3>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label for="singbox-urltest-url" class="form-label">Тестовый URL</label>
                            <input type="text" id="singbox-urltest-url" class="form-input" placeholder="https://www.gstatic.com/generate_204" style="width: 100%; max-width: 400px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label for="singbox-urltest-interval" class="form-label">Интервал проверки</label>
                            <input type="text" id="singbox-urltest-interval" class="form-input" placeholder="3m" style="width: 120px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="singbox-urltest-tolerance" class="form-label">Допуск, мс</label>
                            <input type="number" id="singbox-urltest-tolerance" class="form-input" min="0" placeholder="50" style="width: 100px;">
                        </div>
                    </div>
                    <div class="singbox-proxy-list-wrapper">
                        <div id="singbox-proxy-list" class="singbox-proxy-list"></div>
                        <p id="singbox-proxy-list-hint" class="form-hint singbox-proxy-hint"></p>
                    </div>
                    <div class="settings-singbox-import">
                        <div class="singbox-import-row">
                            <textarea id="singbox-settings-import-input" class="form-input singbox-import-input" rows="2" placeholder="vless://…, vmess://…, trojan://…, ss://…, hy2://… или Base64-подписка"></textarea>
                            <button type="button" class="btn btn-primary" id="singbox-settings-import-btn" onclick="singboxSettingsAddFromLinks()">Добавить</button>
                        </div>
                        <p id="singbox-settings-import-message" class="form-hint"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

        </div>
    </div>

    

    <!-- Переиспользуемые компоненты -->
    <!-- Переиспользуемое модальное окно редактора конфигурации -->
<div id="configEditorModal" class="modal">
    <div class="modal-content config-editor-modal">
        <div class="modal-header">
            <h2 id="configEditorTitle">Редактор конфигурации</h2>
            <span class="close" onclick="closeConfigEditor()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Файл:</label>
                <span id="configEditorFilePath" style="font-family: monospace; color: #6e6e73; font-size: 13px;"></span>
            </div>
            <div class="form-group">
                <textarea id="configEditorText" rows="35" class="form-input config-editor-textarea"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeConfigEditor()">Отмена</button>
            <button class="btn btn-primary" onclick="saveConfigEditor()">Сохранить</button>
        </div>
    </div>
</div>

    <!-- Переиспользуемое модальное окно просмотра логов -->
<div id="logsViewerModal" class="modal">
    <div class="modal-content logs-viewer-modal">
        <div class="modal-header">
            <h2 id="logsViewerTitle">Логи</h2>
            <span class="close" onclick="closeLogsViewer()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <label style="margin: 0;">Количество строк:</label>
                <input type="number" id="logsViewerLines" value="100" min="10" max="1000" class="form-input" style="width: 100px;">
                <button class="btn btn-secondary" onclick="loadLogsViewer()">Обновить</button>
                <span id="logsViewerWarning" style="color: #ff9500; font-size: 13px; margin-left: auto;"></span>
            </div>
            <div class="form-group" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <textarea id="logsViewerText" rows="35" class="form-input logs-viewer-textarea" readonly></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeLogsViewer()">Закрыть</button>
        </div>
    </div>
</div>

    <!-- Переиспользуемое модальное окно подтверждения -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 id="confirmModalTitle">Подтверждение</h2>
            <span class="close" onclick="closeConfirmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="confirmModalCancelBtn" onclick="closeConfirmModal()">Отмена</button>
            <button class="btn btn-danger" id="confirmModalOkBtn" onclick="confirmModalAction()">Подтвердить</button>
        </div>
    </div>
</div>




    <!-- Минималистичный оверлей: пустой круг + бегунок по окружности -->
<div id="progressOverlay" class="progress-overlay" style="display: none;">
    <div class="progress-overlay-spinner">
        <svg class="progress-spinner-svg" width="48" height="48" viewBox="0 0 48 48">
            <circle class="progress-spinner-track" cx="24" cy="24" r="20" fill="none" stroke-width="3"/>
            <circle class="progress-spinner-runner" cx="24" cy="24" r="20" fill="none" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </div>
</div>

    <!-- Всплывающее уведомление -->
    <div id="toast" class="toast">
        <div class="toast-content">
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- Подключение общих JS (auth-check первым: редирект на логин при 401) -->
    <script src="/static/auth-check.js"></script>
    <script src="/static/api-core.js"></script>
    <script src="/static/config-editor.js"></script>
    <script src="/static/logs-viewer.js"></script>
    <script src="/static/confirm-modal.js"></script>
    <script src="/static/progress-overlay.js"></script>
    <script src="/static/mobile-menu.js"></script>
    
<script src="/static/proxy-converter-utils.js"></script>
<script src="/static/proxy-converter-core.js"></script>
<script src="/static/proxy-converter-editor.js"></script>
<script src="/static/singbox-proxies.js"></script>
<script src="/static/settings.js"></script>

</body>
</html>
