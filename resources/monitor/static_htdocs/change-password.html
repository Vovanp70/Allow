<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Смена пароля - Allow</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="/static/style.css">
    
</head>
<body>
    <div class="main-container">
        <!-- Боковое меню слева -->
        <div class="sidebar-menu">
    <div class="sidebar-menu-top">
        <div class="logo-container">
            <h1 class="logo">
                <span class="logo-all">All</span><span class="logo-allow">ow</span>
            </h1>
        </div>
        <a href="/dashboard.html" class="menu-item ">
            <span>Системный монитор</span>
        </a>
        <a href="/settings.html" class="menu-item " >
            <span>Настройки</span>
        </a>
        <a href="/routing.html" class="menu-item ">
            <span>Маршрутизация</span>
        </a>
        <details class="menu-group" >
            <summary class="menu-item menu-group-summary">
                <span>Расширенные настройки</span>
            </summary>
            <div class="menu-sublist">
                <a href="/dnsmasq.html" class="menu-item menu-subitem ">
                    <span>Dnsmasq-full</span>
                </a>
                <a href="/dnsmasq-family.html" class="menu-item menu-subitem ">
                    <span>Dnsmasq-full family</span>
                </a>
                <a href="/stubby.html" class="menu-item menu-subitem ">
                    <span>Stubby</span>
                </a>
                <a href="/stubby-family.html" class="menu-item menu-subitem ">
                    <span>Stubby-family</span>
                </a>
                <a href="/sing-box.html" class="menu-item menu-subitem ">
                    <span>Sing-box</span>
                </a>
            </div>
        </details>
    </div>
    <div class="sidebar-menu-bottom">
        <a href="/change-password.html" class="menu-item active">
            <span>Смена пароля</span>
        </a>
        <a href="/logout.html" class="menu-item menu-item-logout">
            <span>Выход</span>
        </a>
        <div class="sidebar-version">version 0.01</div>
    </div>
</div>


        <!-- Область контента -->
        <div class="content-area">
            
<div class="change-password-page">
    <header>
        <h1>Смена пароля</h1>
    </header>
    <form id="change-password-form" class="change-password-form card">
        <div class="card-content">
            <div class="form-row">
                <label for="current-password">Текущий пароль</label>
                <input type="password" id="current-password" name="current_password" class="form-input" autocomplete="current-password" required>
            </div>
            <div class="form-row">
                <label for="new-password">Новый пароль</label>
                <input type="password" id="new-password" name="new_password" class="form-input" autocomplete="new-password" required minlength="1">
            </div>
            <div class="form-row">
                <label for="confirm-password">Подтверждение нового пароля</label>
                <input type="password" id="confirm-password" name="confirm_password" class="form-input" autocomplete="new-password" required minlength="1">
            </div>
            <p id="change-password-error" class="form-hint change-password-error" role="alert" aria-live="polite" hidden></p>
            <div class="change-password-actions">
                <button type="submit" class="btn btn-primary" id="change-password-submit">Изменить</button>
            </div>
        </div>
    </form>
</div>
<script>
(function() {
    var form = document.getElementById('change-password-form');
    var errorEl = document.getElementById('change-password-error');
    var submitBtn = document.getElementById('change-password-submit');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        errorEl.hidden = true;
        errorEl.textContent = '';

        var newPw = document.getElementById('new-password').value;
        var confirmPw = document.getElementById('confirm-password').value;
        if (newPw !== confirmPw) {
            errorEl.textContent = 'Новый пароль и подтверждение не совпадают';
            errorEl.hidden = false;
            return;
        }

        submitBtn.disabled = true;
        fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                current_password: document.getElementById('current-password').value,
                new_password: newPw
            }),
            credentials: 'same-origin'
        }).then(function(res) {
            return res.json().then(function(data) {
                if (res.ok && data.success) {
                    if (typeof showToast === 'function') {
                        showToast('Пароль изменён');
                    } else {
                        errorEl.textContent = 'Пароль изменён';
                        errorEl.hidden = false;
                        errorEl.style.color = '#0a0';
                    }
                    form.reset();
                } else {
                    errorEl.textContent = data.error || 'Ошибка смены пароля';
                    errorEl.hidden = false;
                }
            });
        }).catch(function() {
            errorEl.textContent = 'Ошибка сети';
            errorEl.hidden = false;
        }).finally(function() {
            submitBtn.disabled = false;
        });
    });
})();
</script>

        </div>
    </div>

    

    <!-- Переиспользуемые компоненты -->
    <!-- Переиспользуемое модальное окно редактора конфигурации -->
<div id="configEditorModal" class="modal">
    <div class="modal-content config-editor-modal">
        <div class="modal-header">
            <h2 id="configEditorTitle">Редактор конфигурации</h2>
            <span class="close" onclick="closeConfigEditor()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Файл:</label>
                <span id="configEditorFilePath" style="font-family: monospace; color: #6e6e73; font-size: 13px;"></span>
            </div>
            <div class="form-group">
                <textarea id="configEditorText" rows="35" class="form-input config-editor-textarea"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeConfigEditor()">Отмена</button>
            <button class="btn btn-primary" onclick="saveConfigEditor()">Сохранить</button>
        </div>
    </div>
</div>

    <!-- Переиспользуемое модальное окно просмотра логов -->
<div id="logsViewerModal" class="modal">
    <div class="modal-content logs-viewer-modal">
        <div class="modal-header">
            <h2 id="logsViewerTitle">Логи</h2>
            <span class="close" onclick="closeLogsViewer()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <label style="margin: 0;">Количество строк:</label>
                <input type="number" id="logsViewerLines" value="100" min="10" max="1000" class="form-input" style="width: 100px;">
                <button class="btn btn-secondary" onclick="loadLogsViewer()">Обновить</button>
                <span id="logsViewerWarning" style="color: #ff9500; font-size: 13px; margin-left: auto;"></span>
            </div>
            <div class="form-group" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <textarea id="logsViewerText" rows="35" class="form-input logs-viewer-textarea" readonly></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeLogsViewer()">Закрыть</button>
        </div>
    </div>
</div>

    <!-- Переиспользуемое модальное окно подтверждения -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 id="confirmModalTitle">Подтверждение</h2>
            <span class="close" onclick="closeConfirmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="confirmModalCancelBtn" onclick="closeConfirmModal()">Отмена</button>
            <button class="btn btn-danger" id="confirmModalOkBtn" onclick="confirmModalAction()">Подтвердить</button>
        </div>
    </div>
</div>




    <!-- Минималистичный оверлей: пустой круг + бегунок по окружности -->
<div id="progressOverlay" class="progress-overlay" style="display: none;">
    <div class="progress-overlay-spinner">
        <svg class="progress-spinner-svg" width="48" height="48" viewBox="0 0 48 48">
            <circle class="progress-spinner-track" cx="24" cy="24" r="20" fill="none" stroke-width="3"/>
            <circle class="progress-spinner-runner" cx="24" cy="24" r="20" fill="none" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </div>
</div>

    <!-- Всплывающее уведомление -->
    <div id="toast" class="toast">
        <div class="toast-content">
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- Подключение общих JS (auth-check первым: редирект на логин при 401) -->
    <script src="/static/auth-check.js"></script>
    <script src="/static/api-core.js"></script>
    <script src="/static/config-editor.js"></script>
    <script src="/static/logs-viewer.js"></script>
    <script src="/static/confirm-modal.js"></script>
    <script src="/static/progress-overlay.js"></script>
    
</body>
</html>
