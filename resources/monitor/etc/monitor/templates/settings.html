{% extends "base.html" %}

{% block title %}Настройки - Allow{% endblock %}

{% block content %}
<div class="settings-page">
    <header class="settings-page-header" role="banner">
        <h1>Настройки</h1>
        <div class="settings-save-bar" id="settings-save-bar" aria-live="polite">
            <span class="settings-unsaved-hint" id="settings-unsaved-hint"></span>
            <button type="button" class="btn btn-primary" id="settings-save-btn" disabled aria-describedby="settings-unsaved-hint">Сохранить</button>
        </div>
    </header>

    <section class="settings-section" aria-labelledby="settings-dot-title" aria-describedby="settings-dot-desc">
        <h2 id="settings-dot-title" class="settings-section-title">Режим работы Stubby (DoT)</h2>
        <p id="settings-dot-desc" class="settings-section-desc">Выберите режим DNS через DoT. Изменения применятся после нажатия «Сохранить».</p>
        <div class="dns-mode-cards" role="group" aria-label="Режим DNS">
            <div class="dns-mode-card" id="mode-adblock" data-mode="adblock" role="button" tabindex="0" aria-pressed="false" aria-label="DoT с блокировкой рекламы и защитой от опасных сайтов">
                <div class="dns-mode-card-header">
                    <h3>DoT + Блокировка рекламы + Защита от опасных сайтов</h3>
                </div>
                <div class="dns-mode-card-body">
                    <p>AdGuard, Control D и аналогичные серверы с фильтрацией рекламы и вредоносных сайтов.</p>
                </div>
            </div>
            <div class="dns-mode-card" id="mode-stable" data-mode="stable" role="button" tabindex="0" aria-pressed="false" aria-label="DoT с защитой от опасных сайтов, без блокировки рекламы">
                <div class="dns-mode-card-header">
                    <h3>DoT + Защита от опасных сайтов</h3>
                </div>
                <div class="dns-mode-card-body">
                    <p>Cloudflare, Yandex и другие стабильные DoT-серверы с защитой от опасных сайтов, без блокировки рекламы.</p>
                </div>
            </div>
            <div class="dns-mode-card dns-mode-card-manual" id="mode-manual" data-mode="manual" role="button" tabindex="0" aria-pressed="false" aria-label="Ручная настройка конфига">
                <div class="dns-mode-card-header">
                    <h3>Ручная настройка (конфиг изменён)</h3>
                </div>
                <div class="dns-mode-card-body">
                    <p>Конфигурация Stubby была изменена вручную. Переключение на adblock или stable применит соответствующий набор серверов.</p>
                </div>
            </div>
        </div>
        <p class="dns-mode-status settings-section-status" id="dns-mode-status"></p>
    </section>

    <section class="settings-section">
        <div class="card settings-card children-filter-card">
            <div class="card-content" role="group" aria-labelledby="children-filter-title">
                <div class="children-filter-text">
                    <h2 id="children-filter-title" class="settings-section-title">Фильтрация контента для детей</h2>
                    <p class="settings-section-desc">Stubby-family и Dnsmasq-full family работают вместе для фильтрации контента на детских устройствах. Включение запускает оба компонента и добавляет их в автозапуск.</p>
                </div>
                <div class="children-filter-toggle-container">
                    <label class="switch" for="children-filter-toggle">
                        <input type="checkbox" id="children-filter-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </section>

    <section class="settings-section">
        <div class="card settings-card updates-card">
            <div class="card-content">
                <div class="updates-main">
                    <h2 class="settings-section-title">Обновления</h2>
                    <p class="settings-section-desc">
                        Синхронизация списков allow (домены, подсети) из upstream и extra-репозитория.
                        Автообновление по cron в 04:00.
                    </p>
                </div>
                <div class="updates-one-row">
                    <span class="settings-card-label">Автообновление</span>
                    <label class="switch">
                        <input type="checkbox" id="sync-allow-autoupdate-toggle">
                        <span class="slider"></span>
                    </label>
                    <span class="settings-card-label updates-one-row-sep">Последнее обновление</span>
                    <span id="sync-allow-last-update">—</span>
                </div>
                <span id="sync-allow-autoupdate-status" class="visually-hidden" aria-hidden="true">—</span>
                <div class="updates-actions-footer">
                    <button type="button" class="btn btn-secondary" id="sync-allow-logs-btn">Посмотреть логи</button>
                    <button type="button" class="btn btn-secondary" id="sync-allow-update-btn">Обновить списки</button>
                </div>
            </div>
        </div>
    </section>

    <section class="settings-section">
        <div class="card settings-card singbox-card">
            <div class="card-content">
                <div class="singbox-main">
                    <h2 class="settings-section-title">Sing-box: прокси (outbound'ы)</h2>
                </div>
                <div class="singbox-body">
                    <div class="singbox-proxy-list-wrapper">
                        <div id="singbox-proxy-list" class="singbox-proxy-list"></div>
                        <p id="singbox-proxy-list-hint" class="form-hint singbox-proxy-hint"></p>
                    </div>
                    <div class="settings-singbox-import">
                        <div class="singbox-import-row">
                            <textarea id="singbox-settings-import-input" class="form-input singbox-import-input" rows="2" placeholder="vless://…, vmess://…, trojan://…, ss://…, hy2://… или Base64-подписка"></textarea>
                            <button type="button" class="btn btn-primary" id="singbox-settings-import-btn" onclick="singboxSettingsAddFromLinks()">Добавить</button>
                        </div>
                        <p id="singbox-settings-import-message" class="form-hint"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='proxy-converter-utils.js') }}"></script>
<script src="{{ url_for('static', filename='proxy-converter-core.js') }}"></script>
<script src="{{ url_for('static', filename='proxy-converter-editor.js') }}"></script>
<script src="{{ url_for('static', filename='singbox-proxies.js') }}"></script>
<script src="{{ url_for('static', filename='settings.js') }}"></script>
{% endblock %}
