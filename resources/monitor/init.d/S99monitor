#!/bin/sh

prefix="/opt"
APP_DIR="${prefix}/etc/allow/monitor"
PATH=${prefix}/bin:${prefix}/sbin:/sbin:/bin:/usr/sbin:/usr/bin
PIDFILE=${prefix}/var/run/monitor.pid
LOGFILE=${prefix}/var/log/allow/monitor/monitor.log
APP=${APP_DIR}/app.py

start() {
    echo "starting system monitor..."
    mkdir -p "${APP_DIR}" "${prefix}/etc/allow/monitor" "$(dirname "$PIDFILE")" "$(dirname "$LOGFILE")"
    
    if [ -f $PIDFILE ] && [ -d /proc/$(cat $PIDFILE) ]; then
        echo "system monitor already running (PID: $(cat $PIDFILE))"
        return 0
    fi
    
    # Ищем и убиваем процессы app.py (совместимо с BusyBox)
    ps w | grep "python3.*${APP}" | grep -v grep | awk '{print $1}' | xargs kill -9 2>/dev/null || true
    sleep 2
    
    # Проверяем и освобождаем порт 8888
    PORT_PID=$(netstat -tlnp 2>/dev/null | grep ":8888 " | awk '{print $7}' | cut -d'/' -f1 | head -1)
    if [ -n "$PORT_PID" ] && [ "$PORT_PID" != "-" ]; then
        kill -9 $PORT_PID 2>/dev/null || true
        sleep 1
    fi
    
    # Запуск в фоне (без nohup, так как его может не быть)
    cd "$APP_DIR" || exit 1
    python3 "$APP" > "$LOGFILE" 2>&1 &
    PID=$!
    echo $PID > $PIDFILE
    
    sleep 3
    
    if [ -f $PIDFILE ] && [ -d /proc/$(cat $PIDFILE) ]; then
        echo "system monitor started successfully (PID: $(cat $PIDFILE))"
        return 0
    else
        echo "failed to start system monitor"
        echo "Last log entries:"
        tail -5 "$LOGFILE" 2>/dev/null || echo "No log file"
        rm -f $PIDFILE
        return 1
    fi
}

stop() {
	echo "stopping system monitor..."
	
	if [ -f $PIDFILE ]; then
		kill $(cat $PIDFILE) 2>/dev/null
		rm -f $PIDFILE
	fi
	
	# Убиваем все процессы app.py на всякий случай (совместимо с BusyBox)
	ps w | grep "python3.*app.py" | grep -v grep | awk '{print $1}' | xargs kill -9 2>/dev/null || true
	sleep 1
	
	echo "system monitor stopped"
}

status() {
    if [ -f $PIDFILE ] && [ -d /proc/$(cat $PIDFILE) ]; then
        echo "system monitor is running (PID: $(cat $PIDFILE))"
        return 0
    else
        echo "system monitor is not running"
        return 1
    fi
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        sleep 2
        start
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0

